<h1 dir='rtl'>
کمک‌دست وان‌سیگنال برای سوییفت
</h1>
<p dir='rtl'>
آقا وان‌سیگنال زد تحریم‌مون کرد!! طوریکه وصل نمیشه تا PlayerID بگیره. برای همین روند ثبت دستگاه توی وان‌سیگنال و بقیه کارایی که باهاش می‌کردیم رو مجبوریم خودمون یجورایی پیاده‌سازی مدیریت کنیم. 
</p>

<hr>

<h2 dir='rtl'>
☝️ قبلا
</h2>
<p dir='rtl'>
روال کلی وان‌سیگنال اینجوری بود (و هست):
<ul dir='rtl'>
  <li>وان‌سیگنال به گوشی میگه می‌خوام با APNs کار کنم. پس یه شناسه دستگاه (یا همون Device Token) بهم بده.</li>
  <li>دستگاه پیام‌های مناسب رو به کاربر نشون میده و ازش اجازه می‌گیره، و بعدش به اپل میگه آقا این دستگاه رو ثبتش کن و یه شناسه دستگاه بده من. در نهایت شناسه رو که گرفت، تحویل کلاینت وان‌سیگنال میده.</li>
  <li>کلاینت وان‌سیگنال وقتی شناسه دستگاه رو گرفت، می‌فرسته سمت سرور وان‌سیگنال (البته بهمراه یه سری اطلاعات دیگه)، تا توی پایگاه داده خودش، یه دستگاه با اطلاعات مربوطه ثبت کنه، و برای اون دستگاه یه شناسه یکتا بسازه. دقت کنین شناسه جدید، مختص خود وان‌سیگنال هست، و برای جای دیگه استفاده نمیشه.</li>
  <li>کارای ثبت دستگاه که تموم شد، و شناسه وان‌سیگنالی دستگاه که ساخته شد، سرور وان‌سیگنال، شناسه ساخته شده رو بعنوان پاسخ درخواست کلاینتش، براش می‌فرسته.</li>
  <li>حالا کلاینت وان‌سیگنال می‌دونه شناسه‌اش توی سرور وان‌سیگنال چیه. و البته این شناسه رو در اختیار شمام قرار میده، تا اگه می‌خواین باهاش کار کنین.</li>
</ul>
</p>


<h2 dir='rtl'>
👇 الان
</h2>
<p dir='rtl'>
الان اتفاقی که افتاده اینه که، وان‌سیگنال مارو تحریم کرده، و ارتباط بین کلاینت وان‌سیگنال، و سرور وان‌سیگنال، توی ایران برقرار نمیشه. پس سرور وان‌سیگنال، از وجود دستگاه با خبر نمیشه، و در نتیجه شناسه‌ای هم براش تولید نمی‌کنه. پس ما هم نمی‌تونیم با استفاده از وان‌سیگنال برای کاربرا نوتیفیکیشن بفرستیم؛ نه بصورت عمومی، و نه بصورت خصوصی.
</p>

<h2 dir='rtl'>
حالا چیکار کنیم؟ 🤔
</h2>
<p dir='rtl'>
مجبوریم اون جای خالی بین کلاینت وان‌سیگنال و سرور وان‌سیگنال رو خودمون پر کنیم. به این صورت که بین اون دوتا بشینیم، درخواست کلاینت رو تحویل بگیریم، و تحویل سرور وان‌سیگنال بدیم. 
چه زندگی داریم آخه؟!... 😕
</p>

<hr>

<h2 dir='rtl'>
توضیحات استفاده
</h2>

<br>
<h3 dir='rtl'>پیکربندی</h3>
<p dir='rtl'>
قبل از هر کاری، باید پیکربندی انجام بشه. توی پیکربندی، ما داریم اطلاعات مورد نیاز برای کارهای بعدی رو آماده می‌کنیم. برای پیکربندی از متد زیر استفاده می‌کنیم:
</p>

```swift
IDOneSignal.Setup(baseURL: String, appID: String, routes: (addDevice: String, editDevice: String))
```

<ul dir='rtl'>
  <li>پارامتر <code>baseURL</code> مشخص‌کننده آدرس پایه سرور شماست (که قرار بعنوان واسط قرار بگیره).</li>
  <li>پارامتر <code>appID</code> همون شناسه مربوط به اپلیکیشن میشه که پنل وان‌سیگنال بهتون میده.</li>
  <li>پارامتر <code>routes</code> مشخص‌کننده آدرس نسبی، برای اکشن‌های ثبت دستگاه و ویرایش دستگاه هست. البته این پارامتر دارای مقدار پیشفرض <code>("onesignal/adddevice", "onesignal/editdevice")</code> هست؛ یعنی می‌تونین مثلا یه کنترلر به نام <code>onesignal</code> بهمراه دوتا اکشن <code>adddevice</code> و <code>editdevice</code> پیاده‌سازی کنین و بعد از این آدرس‌ها برای امور مربوطه استفاده کنین.</li>
</ul>

<br>
<h3 dir='rtl'>انجام امور</h3>
<p dir='rtl'>
متد کلی برای انجام امور، بصورت زیر تعریف شده:
</p>

```swift
IDOneSignal.Perform(action: IDOneSignalAction, then callback: (IDOneSignalActionError?, Any?) -> Void)
```

<ul dir='rtl'>
  <li>پارامتر <code>action</code> از نوع <code>IDOneSignalAction</code> هست، که در واقع یه <code>enum</code> هست. من براساس نیاز خودم، اعمال ثبت دستگاه، مشترک شدن، لغو اشتراک، و ثبت برچسب رو در  نظر گرفتم:
  </li>
</ul>

```swift
public enum IDOneSignalAction {
    case addDevice(token: String)
    case subscribe
    case unsubscribe
    case setTags(tags: [String: Any])
}
```
<ul dir='rtl'>
  <li>پارامتر <code>callback</code> هم از نوع <code dir='ltr'>(IDOneSignalActionError?, Any?) -> Void</code> هست که در واقع یه <code>Closure</code> هست که نتیجه اون عمل رو برمیگردونه. خودش دوتا پارامتر داره. اولی خطای احتمالی رو مشخص می‌کنه، و دومی داده دریافتی احتمالی رو. اون خطای احتمالی، یکی از خطاهای زیر خواهد بود:
  </li>
</ul>

```swift
public enum IDOneSignalActionError: Error, CustomStringConvertible {
    case missingDeviceToken
    case missingPlayerID
    case isNotConfigured
    case invalidResponse
    case custom(message: String)
}
```

<br>
<h3 dir='rtl'>
گرفتن شناسه وان‌سیگنالی دستگاه
</h3>
<p dir='rtl'>
اگه همه‌چی درست و بدون مشکل انجام بشه، و دستگاه بواسطه سرور شما، بدون مشکل توی وان‌سیگنال ثبت بشه، شما برای گرفتن <code>PlayerID</code> مربوط به وان‌سیگنال، از کد زیر می‌تونین استفاده کنین:
</p>

```swift
let playerID = IDOneSignal.PlayerID
```

<p dir='rtl'>دقت داشته باشین که نوع این متغیر <code dir='ltr'>String?</code> هست؛ و اگه مشکلی پیش اومده باشه، یا دستگاه بدرستی ثبت نشده باشه، مقدار این متغیر برابر <code>nil</code> خواهد بود.
</p>

<p dir='rtl'></p>